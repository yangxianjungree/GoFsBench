# Go Filesystem bench

## 1. 信息

## 2. 性能数据

在自己的虚拟机上测试

### 2.1 机器规格

- 1.操作系统

```shell
# uname -a

Linux xxx 5.11.0-34-generic #36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
```

- 2.硬件

  - CPU
    英特尔 Core i7-8700 @ 3.20GHz 六核 @ 3.20GHz

  - 内存
    8G

  - 磁盘
    机械硬盘

  - 网卡
    英特尔 Ethernet Connection  I219-V / 华擎 (千兆网卡)

    ```s
    iperf3 -s
    ...
    iperf3 -c 127.0.0.1 -t 60
    ...
    [ ID] Interval           Transfer     Bitrate         Retr
    [  5]   0.00-60.00  sec   331 GBytes  47.3 Gbits/sec    0             sender
    [  5]   0.00-60.00  sec   331 GBytes  47.3 Gbits/sec                  receiver
    ```

### 2.2 数据

#### 2.2.1 日志

```s
# go test -bench=. -cpu=16 -benchtime="5s" -benchmem

goos: linux
goarch: amd64
pkg: common
cpu: Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz
BenchmarkLogging-16      2915629          2065 ns/op          56 B/op          2 allocs/op
PASS
ok      common  8.108s
```

#### 2.2.2 协议解析

- 使用 json 序列化和反序列化

|协程数/数据（协议126字节）|请求数|qps|耗时ms|cs|
|--|--|--|--|--|--|
|500|100,000|121359|824|
|1000|100,000|110375|906|
|5000|100,000|80906|1236|
|10000|100,000|67980|1471|
|10|10,000,000|40450|247217 ms|11w|
|50|10,000,000|94147|106216 ms|5+w|
|100|10,000,000|108043|92555 ms|4w|
|500|10,000,000|113930|87773|3w|
|1000|10,000,000|105451|94830|
|5000|10,000,000|93240|107250|
|10000|10,000,000|82715|120896|

- 使用 protobuf 序列化和反序列化

|协程数/数据（协议只需39字节）|请求数|qps|耗时|cs|
|--|--|--|--|--|--|
|5|100,000|27374|3653 ms|
|10|100,000|56433|1772 ms|
|50|100,000|109170|916 ms|
|100|100,000|121654|822 ms|
|500|100,000|162601|615 ms|
|1000|100,000|112107|892 ms|
|5000|100,000|106157|942 ms|
|10000|100,000|87950|1137 ms|
|5|10,000,000|27874|358757 ms|12w|
|10|10,000,000|46093|216950 ms|11w|
|50|10,000,000|98538|101483 ms|7w|
|100|10,000,000|119047|84000 ms|5w|
|500|10,000,000|157304|63571 ms|2.4w|
|1000|10,000,000|146222|68389 ms|2.2w|
|5000|10,000,000|125368|79765 ms|1.5w|
|10000|10,000,000|132215|75634 ms|

##### ！！协程数越来越多，线程逐渐增加。小于500时，si只有个别比较高；在超过500时，nvcswch/s越来越大

#### 2.2.3 上传

- PAGE_SIZE = 4k

|文件大小(byte)/数据|请求数|50协程|100协程|500协程|1000协程|
|--|--|--|--|--|--|--|--|
|5K|2,000,000|qps:3058 time:653845|qps:3974 time:503158|qps:5912 time:338282|qps:4085 time:489587|
|50K|200,000|-|-|qps:881 time:226914|-|
|500K|20,000|-|-|qps:85 time:233628|-|
|1M|10,000|协程:20 qps:41 time:238854|qps:45 time:221450|qps:48 time:204659|协程:2500 qps:46 time:217310|
|5M|2,000|-|-|qps:12 time:164579|-|
|50M|200|-|-|qps:0.8 time:241598|-|

- PAGE_SIZE = 40k

|文件大小(byte)/数据|请求数|500协程|100协程|20协程|2500协程|
|--|--|--|--|--|--|
|5K|2,000,000|qps:4304 time:464638|
|50K|200,000|qps:783 time:255344|
|500K|20,000|qps:80 time:247030|
|1M|10,000|qps:50 time:197729|qps:48 time:206938|qps:62 time:160783|qps:40 time:250057|
|5M|2,000|qps:15 time:130722|
|50M|200|qps:1 time:187825|

- PAGE_SIZE = 400k

|文件大小(byte)/数据|请求数|500协程|100协程|20协程|2500协程|
|--|--|--|--|--|--|
|5K|2,000,000|qps:3710 time:538988|
|50K|200,000|qps:805 time:248280|
|500K|20,000|qps:109 time:182115|
|1M|10,000|qps:48 time:204591|qps:40 time:248363|qps:44 time:224613|qps:28 time:351511|
|5M|2,000|qps:13 time:148810|
|50M|200|qps:0.9 time:214528|

#### 2.2.4 查询

|文件大小(byte)/数据|请求数|耗时|协程数|400K负载|重复次数|qps|
|--|--|--|--|--|--|--|
|4K|||||||
|40K|||||||
|400K||||||
|4M||||||
|40M||||||
|400M||||||
|4G||||||

#### 2.2.5 下载

#### 2.2.6 删除
